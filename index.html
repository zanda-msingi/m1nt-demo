<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ask Your Binder</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #122023;
    color: #e0e0e0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px 20px;
  }
  .vdf-brand {
    text-align: center;
    margin-bottom: 32px;
  }
  .vdf-brand img {
    height: 48px;
    opacity: 0.9;
  }
  .header {
    text-align: center;
    margin-bottom: 40px;
  }
  .header h1 {
    font-size: 28px;
    font-weight: 600;
    color: #ffffff;
    margin-bottom: 6px;
  }
  .header p {
    font-size: 14px;
    color: #888;
  }
  .footer {
    margin-top: auto;
    padding-top: 48px;
    text-align: center;
  }
  .footer img {
    height: 72px;
    margin-bottom: 8px;
    opacity: 0.7;
  }
  .footer p {
    font-size: 11px;
    color: #dffba8;
    letter-spacing: 0.5px;
  }
  .container {
    width: 100%;
    max-width: 720px;
  }
  .input-area {
    display: flex;
    gap: 10px;
    margin-bottom: 24px;
  }
  .input-area input {
    flex: 1;
    padding: 14px 18px;
    font-size: 15px;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 8px;
    color: #fff;
    outline: none;
    transition: border-color 0.2s;
  }
  .input-area input:focus { border-color: #dffba8; }
  .input-area input::placeholder { color: #555; }
  .input-area button {
    padding: 14px 28px;
    font-size: 15px;
    font-weight: 500;
    background: #dffba8;
    color: #122023;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
    white-space: nowrap;
  }
  .input-area button:hover { background: #c8f078; }
  .input-area button:disabled {
    background: #333;
    cursor: not-allowed;
  }
  .response-card {
    background: #141414;
    border: 1px solid #222;
    border-radius: 10px;
    padding: 28px;
    line-height: 1.7;
    font-size: 14.5px;
    display: none;
  }
  .response-card.visible { display: block; }
  .response-card h2, .response-card h3 {
    color: #fff;
    margin-top: 16px;
    margin-bottom: 8px;
  }
  .response-card h2 { font-size: 16px; }
  .response-card h3 { font-size: 14.5px; }
  .response-card p { margin-bottom: 10px; }
  .response-card strong { color: #c4b5fd; }
  .response-card ul, .response-card ol {
    margin-left: 20px;
    margin-bottom: 10px;
  }
  .response-card li { margin-bottom: 4px; }
  .response-card table {
    width: 100%;
    border-collapse: collapse;
    margin: 12px 0;
    font-size: 13.5px;
  }
  .response-card th, .response-card td {
    text-align: left;
    padding: 8px 12px;
    border-bottom: 1px solid #222;
  }
  .response-card th { color: #a5a5a5; font-weight: 500; }
  .response-card hr {
    border: none;
    border-top: 1px solid #222;
    margin: 16px 0;
  }
  .meta {
    margin-top: 20px;
    padding-top: 14px;
    border-top: 1px solid #222;
    font-size: 12px;
    color: #555;
    display: flex;
    justify-content: space-between;
  }
  .spinner {
    display: none;
    text-align: center;
    padding: 40px;
    color: #888;
    font-size: 14px;
  }
  .spinner.visible { display: block; }
  .spinner::before {
    content: '';
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #333;
    border-top-color: #dffba8;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 10px;
    vertical-align: middle;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .error {
    background: #1a0a0a;
    border-color: #3a1515;
    color: #f87171;
  }
  .disclaimer {
    font-size: 11px;
    color: #dffba8;
    text-align: center;
    margin: -14px 0 20px;
  }
  .query-echo {
    font-size: 13px;
    color: #666;
    margin-bottom: 16px;
    font-style: italic;
  }
</style>
</head>
<body>

<div class="vdf-brand">
  <img src="vdf-logo.png" alt="VDF Yamazaki">
</div>

<div class="header">
  <h1>Ask Your Binder</h1>
  <p>m1NT &mdash; Smart Binder QMS Agent</p>
</div>

<div class="container">
  <div class="input-area">
    <input type="text" id="query" placeholder="Ask a question about your quality records..." autofocus>
    <button id="submit" onclick="askBinder()">Ask</button>
  </div>

  <p class="disclaimer">AI-generated responses may contain errors. Always verify critical information against source documents.</p>

  <div class="spinner" id="spinner">Searching your binder...</div>

  <div class="response-card" id="response">
    <div class="query-echo" id="queryEcho"></div>
    <div id="responseBody"></div>
    <div class="meta">
      <span id="metaModel"></span>
      <span id="metaTime"></span>
    </div>
  </div>
</div>

<div class="footer">
  <img src="m1NT.png" alt="MATANGA">
  <p>powered by MATANGA Intelligence</p>
</div>

<script>
const WEBHOOK_URL = 'https://zandap.app.n8n.cloud/webhook/ask-your-binder';

document.getElementById('query').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') askBinder();
});

async function askBinder() {
  const input = document.getElementById('query');
  const query = input.value.trim();
  if (!query) return;

  const btn = document.getElementById('submit');
  const spinner = document.getElementById('spinner');
  const card = document.getElementById('response');

  btn.disabled = true;
  card.classList.remove('visible');
  card.classList.remove('error');
  spinner.classList.add('visible');

  const start = Date.now();

  try {
    const res = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query })
    });

    const data = await res.json();
    const elapsed = ((Date.now() - start) / 1000).toFixed(1);
    const item = Array.isArray(data) ? data[0] : data;

    document.getElementById('queryEcho').textContent = '"' + query + '"';
    document.getElementById('responseBody').innerHTML = markdownToHtml(item.response || 'No response received.');
    document.getElementById('metaModel').textContent = item.model || '';
    document.getElementById('metaTime').textContent = elapsed + 's';

    if (item.error) card.classList.add('error');
    card.classList.add('visible');
  } catch (err) {
    document.getElementById('queryEcho').textContent = '"' + query + '"';
    document.getElementById('responseBody').innerHTML = '<p>Connection error: ' + err.message + '</p>';
    document.getElementById('metaModel').textContent = '';
    document.getElementById('metaTime').textContent = '';
    card.classList.add('error', 'visible');
  } finally {
    btn.disabled = false;
    spinner.classList.remove('visible');
    input.select();
  }
}

function markdownToHtml(md) {
  let html = md
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    // Tables
    .replace(/^\|(.+)\|\s*\n\|[-| :]+\|\s*\n((?:\|.+\|\s*\n?)*)/gm, (match, header, body) => {
      const ths = header.split('|').map(h => h.trim()).filter(Boolean).map(h => '<th>' + h + '</th>').join('');
      const rows = body.trim().split('\n').map(row => {
        const tds = row.split('|').map(c => c.trim()).filter(Boolean).map(c => '<td>' + c + '</td>').join('');
        return '<tr>' + tds + '</tr>';
      }).join('');
      return '<table><thead><tr>' + ths + '</tr></thead><tbody>' + rows + '</tbody></table>';
    })
    // Headers
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    // Horizontal rules
    .replace(/^---$/gm, '<hr>')
    // Bold
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    // Italic
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    // Unordered lists
    .replace(/^- (.+)$/gm, '<li>$1</li>')
    // Ordered lists
    .replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>')
    // Paragraphs
    .replace(/\n{2,}/g, '</p><p>')
    .replace(/\n/g, '<br>');

  // Wrap consecutive <li> in <ul>
  html = html.replace(/((?:<li>.*?<\/li>\s*(?:<br>)?)+)/g, '<ul>$1</ul>');
  html = html.replace(/<br><\/ul>/g, '</ul>');
  html = html.replace(/<ul><br>/g, '<ul>');

  return '<p>' + html + '</p>';
}
</script>

</body>
</html>

